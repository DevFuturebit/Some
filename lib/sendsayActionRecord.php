<?php
namespace futurbit;

require_once("functions.php");

class sendsayActionRecord extends sendsayAction {

    public $logfilename = 'm_check_eyes.log';

    public $sub_send_params = Array(
        "action" => "issue.send",
        "letter" => array("draft.id" => "245"),
        "group" => "personal",
        "mute" => "1",
        "sendwhen" => "now");

    public $sub_detach_params = Array(
        "action" => "member.head.detach",
    );

    private $promos = Array(
        "2700540064767" => "01.01.2020",
        "2700540064774" => "02.01.2020",
        "2700540064781" => "03.01.2020",
        "2700540064798" => "04.01.2020",
        "2700540064804" => "05.01.2020",
        "2700540064811" => "06.01.2020",
        "2700540064828" => "07.01.2020",
        "2700540064835" => "08.01.2020",
        "2700540064842" => "09.01.2020",
        "2700540064859" => "10.01.2020",
        "2700540064866" => "11.01.2020",
        "2700540064873" => "12.01.2020",
        "2700540064880" => "13.01.2020",
        "2700540064897" => "14.01.2020",
        "2700540064903" => "15.01.2020",
        "2700540064910" => "16.01.2020",
        "2700540064927" => "17.01.2020",
        "2700540064934" => "18.01.2020",
        "2700540064941" => "19.01.2020",
        "2700540064958" => "20.01.2020",
        "2700540064965" => "21.01.2020",
        "2700540064972" => "22.01.2020",
        "2700540064989" => "23.01.2020",
        "2700540064996" => "24.01.2020",
        "2700540065009" => "25.01.2020",
        "2700540065016" => "26.01.2020",
        "2700540065023" => "27.01.2020",
        "2700540065030" => "28.01.2020",
        "2700540065047" => "29.01.2020",
        "2700540065054" => "30.01.2020",
        "2700540065061" => "31.01.2020",
        "2700540065078" => "01.02.2020",
        "2700540065085" => "02.02.2020",
        "2700540065092" => "03.02.2020",
        "2700540065108" => "04.02.2020",
        "2700540065115" => "05.02.2020",
        "2700540065122" => "06.02.2020",
        "2700540065139" => "07.02.2020",
        "2700540065146" => "08.02.2020",
        "2700540065153" => "09.02.2020",
        "2700540065160" => "10.02.2020",
        "2700540065177" => "11.02.2020",
        "2700540065184" => "12.02.2020",
        "2700540065191" => "13.02.2020",
        "2700540065207" => "14.02.2020",
        "2700540065214" => "15.02.2020",
        "2700540065221" => "16.02.2020",
        "2700540065238" => "17.02.2020",
        "2700540065245" => "18.02.2020",
        "2700540065252" => "19.02.2020",
        "2700540065269" => "20.02.2020",
        "2700540065276" => "21.02.2020",
        "2700540065283" => "22.02.2020",
        "2700540065290" => "23.02.2020",
        "2700540065306" => "24.02.2020",
        "2700540065313" => "25.02.2020",
        "2700540065320" => "26.02.2020",
        "2700540065337" => "27.02.2020",
        "2700540065344" => "28.02.2020",
        "2700540065351" => "29.02.2020",
        "2700540065368" => "01.03.2020",
        "2700540065375" => "02.03.2020",
        "2700540065382" => "03.03.2020",
        "2700540065399" => "04.03.2020",
        "2700540065405" => "05.03.2020",
        "2700540065412" => "06.03.2020",
        "2700540065429" => "07.03.2020",
        "2700540065436" => "08.03.2020",
        "2700540065443" => "09.03.2020",
        "2700540065450" => "10.03.2020",
        "2700540065467" => "11.03.2020",
        "2700540065474" => "12.03.2020",
        "2700540065481" => "13.03.2020",
        "2700540065498" => "14.03.2020",
        "2700540065504" => "15.03.2020",
        "2700540065511" => "16.03.2020",
        "2700540065528" => "17.03.2020",
        "2700540065535" => "18.03.2020",
        "2700540065542" => "19.03.2020",
        "2700540065559" => "20.03.2020",
        "2700540065566" => "21.03.2020",
        "2700540065573" => "22.03.2020",
        "2700540065580" => "23.03.2020",
        "2700540065597" => "24.03.2020",
        "2700540065603" => "25.03.2020",
        "2700540065610" => "26.03.2020",
        "2700540065627" => "27.03.2020",
        "2700540065634" => "28.03.2020",
        "2700540065641" => "29.03.2020",
        "2700540065658" => "30.03.2020",
        "2700540065665" => "31.03.2020",
        "2700540065672" => "01.04.2020",
        "2700540065689" => "02.04.2020",
        "2700540065696" => "03.04.2020",
        "2700540065702" => "04.04.2020",
        "2700540065719" => "05.04.2020",
        "2700540065726" => "06.04.2020",
        "2700540065733" => "07.04.2020",
        "2700540065740" => "08.04.2020",
        "2700540065757" => "09.04.2020",
        "2700540065764" => "10.04.2020",
        "2700540065771" => "11.04.2020",
        "2700540065788" => "12.04.2020",
        "2700540065795" => "13.04.2020",
        "2700540065801" => "14.04.2020",
        "2700540065818" => "15.04.2020",
        "2700540065825" => "16.04.2020",
        "2700540065832" => "17.04.2020",
        "2700540065849" => "18.04.2020",
        "2700540065856" => "19.04.2020",
        "2700540065863" => "20.04.2020",
        "2700540065870" => "21.04.2020",
        "2700540065887" => "22.04.2020",
        "2700540065894" => "23.04.2020",
        "2700540065900" => "24.04.2020",
        "2700540065917" => "25.04.2020",
        "2700540065924" => "26.04.2020",
        "2700540065931" => "27.04.2020",
        "2700540065948" => "28.04.2020",
        "2700540065955" => "29.04.2020",
        "2700540065962" => "30.04.2020",
        "2700540065979" => "01.05.2020",
        "2700540065986" => "02.05.2020",
        "2700540065993" => "03.05.2020",
        "2700540066006" => "04.05.2020",
        "2700540066013" => "05.05.2020",
        "2700540066020" => "06.05.2020",
        "2700540066037" => "07.05.2020",
        "2700540066044" => "08.05.2020",
        "2700540066051" => "09.05.2020",
        "2700540066068" => "10.05.2020",
        "2700540066075" => "11.05.2020",
        "2700540066082" => "12.05.2020",
        "2700540066099" => "13.05.2020",
        "2700540066105" => "14.05.2020",
        "2700540066112" => "15.05.2020",
        "2700540066129" => "16.05.2020",
        "2700540066136" => "17.05.2020",
        "2700540066143" => "18.05.2020",
        "2700540066150" => "19.05.2020",
        "2700540066167" => "20.05.2020",
        "2700540066174" => "21.05.2020",
        "2700540066181" => "22.05.2020",
        "2700540066198" => "23.05.2020",
        "2700540066204" => "24.05.2020",
        "2700540066211" => "25.05.2020",
        "2700540066228" => "26.05.2020",
        "2700540066235" => "27.05.2020",
        "2700540066242" => "28.05.2020",
        "2700540066259" => "29.05.2020",
        "2700540066266" => "30.05.2020",
        "2700540066273" => "31.05.2020",
        "2700540066280" => "01.06.2020",
        "2700540066297" => "02.06.2020",
        "2700540066303" => "03.06.2020",
        "2700540066310" => "04.06.2020",
        "2700540066327" => "05.06.2020",
        "2700540066334" => "06.06.2020",
        "2700540066341" => "07.06.2020",
        "2700540066358" => "08.06.2020",
        "2700540066365" => "09.06.2020",
        "2700540066372" => "10.06.2020",
        "2700540066389" => "11.06.2020",
        "2700540066396" => "12.06.2020",
        "2700540066402" => "13.06.2020",
        "2700540066419" => "14.06.2020",
        "2700540066426" => "15.06.2020",
        "2700540066433" => "16.06.2020",
        "2700540066440" => "17.06.2020",
        "2700540066457" => "18.06.2020",
        "2700540066464" => "19.06.2020",
        "2700540066471" => "20.06.2020",
        "2700540066488" => "21.06.2020",
        "2700540066495" => "22.06.2020",
        "2700540066501" => "23.06.2020",
        "2700540066518" => "24.06.2020",
        "2700540066525" => "25.06.2020",
        "2700540066532" => "26.06.2020",
        "2700540066549" => "27.06.2020",
        "2700540066556" => "28.06.2020",
        "2700540066563" => "29.06.2020",
        "2700540066570" => "30.06.2020",
        "2700540066587" => "01.07.2020",
        "2700540066594" => "02.07.2020",
        "2700540066600" => "03.07.2020",
        "2700540066617" => "04.07.2020",
        "2700540066624" => "05.07.2020",
        "2700540066631" => "06.07.2020",
        "2700540066648" => "07.07.2020",
        "2700540066655" => "08.07.2020",
        "2700540066662" => "09.07.2020",
        "2700540066679" => "10.07.2020",
        "2700540066686" => "11.07.2020",
        "2700540066693" => "12.07.2020",
        "2700540066709" => "13.07.2020",
        "2700540066716" => "14.07.2020",
        "2700540066723" => "15.07.2020",
        "2700540066730" => "16.07.2020",
        "2700540066747" => "17.07.2020",
        "2700540066754" => "18.07.2020",
        "2700540066761" => "19.07.2020",
        "2700540066778" => "20.07.2020",
        "2700540066785" => "21.07.2020",
        "2700540066792" => "22.07.2020",
        "2700540066808" => "23.07.2020",
        "2700540066815" => "24.07.2020",
        "2700540066822" => "25.07.2020",
        "2700540066839" => "26.07.2020",
        "2700540066846" => "27.07.2020",
        "2700540066853" => "28.07.2020",
        "2700540066860" => "29.07.2020",
        "2700540066877" => "30.07.2020",
        "2700540066884" => "31.07.2020",
        "2700540066891" => "01.08.2020",
        "2700540066907" => "02.08.2020",
        "2700540066914" => "03.08.2020",
        "2700540066921" => "04.08.2020",
        "2700540066938" => "05.08.2020",
        "2700540066945" => "06.08.2020",
        "2700540066952" => "07.08.2020",
        "2700540066969" => "08.08.2020",
        "2700540066976" => "09.08.2020",
        "2700540066983" => "10.08.2020",
        "2700540066990" => "11.08.2020",
        "2700540067003" => "12.08.2020",
        "2700540067010" => "13.08.2020",
        "2700540067027" => "14.08.2020",
        "2700540067034" => "15.08.2020",
        "2700540067041" => "16.08.2020",
        "2700540067058" => "17.08.2020",
        "2700540067065" => "18.08.2020",
        "2700540067072" => "19.08.2020",
        "2700540067089" => "20.08.2020",
        "2700540067096" => "21.08.2020",
        "2700540067102" => "22.08.2020",
        "2700540067119" => "23.08.2020",
        "2700540067126" => "24.08.2020",
        "2700540067133" => "25.08.2020",
        "2700540067140" => "26.08.2020",
        "2700540067157" => "27.08.2020",
        "2700540067164" => "28.08.2020",
        "2700540067171" => "29.08.2020",
        "2700540067188" => "30.08.2020",
        "2700540067195" => "31.08.2020",
        "2700540067201" => "01.09.2020",
        "2700540067218" => "02.09.2020",
        "2700540067225" => "03.09.2020",
        "2700540067232" => "04.09.2020",
        "2700540067249" => "05.09.2020",
        "2700540067256" => "06.09.2020",
        "2700540067263" => "07.09.2020",
        "2700540067270" => "08.09.2020",
        "2700540067287" => "09.09.2020",
        "2700540067294" => "10.09.2020",
        "2700540067300" => "11.09.2020",
        "2700540067317" => "12.09.2020",
        "2700540067324" => "13.09.2020",
        "2700540067331" => "14.09.2020",
        "2700540067348" => "15.09.2020",
        "2700540067355" => "16.09.2020",
        "2700540067362" => "17.09.2020",
        "2700540067379" => "18.09.2020",
        "2700540067386" => "19.09.2020",
        "2700540067393" => "20.09.2020",
        "2700540067409" => "21.09.2020",
        "2700540067416" => "22.09.2020",
        "2700540067423" => "23.09.2020",
        "2700540067430" => "24.09.2020",
        "2700540067447" => "25.09.2020",
        "2700540067454" => "26.09.2020",
        "2700540067461" => "27.09.2020",
        "2700540067478" => "28.09.2020",
        "2700540067485" => "29.09.2020",
        "2700540067492" => "30.09.2020",
        "2700540067508" => "01.10.2020",
        "2700540067515" => "02.10.2020",
        "2700540067522" => "03.10.2020",
        "2700540067539" => "04.10.2020",
        "2700540067546" => "05.10.2020",
        "2700540067553" => "06.10.2020",
        "2700540067560" => "07.10.2020",
        "2700540067577" => "08.10.2020",
        "2700540067584" => "09.10.2020",
        "2700540067591" => "10.10.2020",
        "2700540067607" => "11.10.2020",
        "2700540067614" => "12.10.2020",
        "2700540067621" => "13.10.2020",
        "2700540067638" => "14.10.2020",
        "2700540067645" => "15.10.2020",
        "2700540067652" => "16.10.2020",
        "2700540067669" => "17.10.2020",
        "2700540067676" => "18.10.2020",
        "2700540067683" => "19.10.2020",
        "2700540067690" => "20.10.2020",
        "2700540067706" => "21.10.2020",
        "2700540067713" => "22.10.2020",
        "2700540067720" => "23.10.2020",
        "2700540067737" => "24.10.2020",
        "2700540067744" => "25.10.2020",
        "2700540067751" => "26.10.2020",
        "2700540067768" => "27.10.2020",
        "2700540067775" => "28.10.2020",
        "2700540067782" => "29.10.2020",
        "2700540067799" => "30.10.2020",
        "2700540067805" => "31.10.2020",
        "2700540067812" => "01.11.2020",
        "2700540067829" => "02.11.2020",
        "2700540067836" => "03.11.2020",
        "2700540067843" => "04.11.2020",
        "2700540067850" => "05.11.2020",
        "2700540067867" => "06.11.2020",
        "2700540067874" => "07.11.2020",
        "2700540067881" => "08.11.2020",
        "2700540067898" => "09.11.2020",
        "2700540067904" => "10.11.2020",
        "2700540067911" => "11.11.2020",
        "2700540067928" => "12.11.2020",
        "2700540067935" => "13.11.2020",
        "2700540067942" => "14.11.2020",
        "2700540067959" => "15.11.2020",
        "2700540067966" => "16.11.2020",
        "2700540067973" => "17.11.2020",
        "2700540067980" => "18.11.2020",
        "2700540067997" => "19.11.2020",
        "2700540068000" => "20.11.2020",
        "2700540068017" => "21.11.2020",
        "2700540068024" => "22.11.2020",
        "2700540068031" => "23.11.2020",
        "2700540068048" => "24.11.2020",
        "2700540068055" => "25.11.2020",
        "2700540068062" => "26.11.2020",
        "2700540068079" => "27.11.2020",
        "2700540068086" => "28.11.2020",
        "2700540068093" => "29.11.2020",
        "2700540068109" => "30.11.2020",
        "2700540068116" => "01.12.2020",
        "2700540068123" => "02.12.2020",
        "2700540068130" => "03.12.2020",
        "2700540068147" => "04.12.2020",
        "2700540068154" => "05.12.2020",
        "2700540068161" => "06.12.2020",
        "2700540068178" => "07.12.2020",
        "2700540068185" => "08.12.2020",
        "2700540068192" => "09.12.2020",
        "2700540068208" => "10.12.2020",
        "2700540068215" => "11.12.2020",
        "2700540068222" => "12.12.2020",
        "2700540068239" => "13.12.2020",
        "2700540068246" => "14.12.2020",
        "2700540068253" => "15.12.2020",
        "2700540068260" => "16.12.2020",
        "2700540068277" => "17.12.2020",
        "2700540068284" => "18.12.2020",
        "2700540068291" => "19.12.2020",
        "2700540068307" => "20.12.2020",
        "2700540068314" => "21.12.2020",
        "2700540068321" => "22.12.2020",
        "2700540068338" => "23.12.2020",
        "2700540068345" => "24.12.2020",
        "2700540068352" => "25.12.2020",
        "2700540068369" => "26.12.2020",
        "2700540068376" => "27.12.2020",
        "2700540068383" => "28.12.2020",
        "2700540068390" => "29.12.2020",
        "2700540068406" => "30.12.2020",
        "2700540068413" => "31.12.2020"
        );

    public $cities = array ( // чтобы записать в сендсей смещение нужное для города, надо от москвы отнять нужный город. формула: нужное вермя = переданое + смещение
        'калининград' => 2,
        'москва' => 3,
        'санкт-петербург' => 3,
        'нижний новгород' => 3,
        'ростов-на-дону' => 3,
        'воронеж' => 3,
        'волгоград' => 3,
        'саратов' => 3,
        'краснодар' => 3,
        'ульяновск' => 4,
        'ярославль' => 3,
        'махачкала' => 3,
        'рязань' => 3,
        'астрахань' => 3,
        'набережные челны' => 3,
        'пенза' => 3,
        'липецк' => 3,
        'киров' => 3,
        'тула' => 3,
        'чебоксары' => 3,
        'курск' => 3,
        'ставрополь' => 3,
        'севастополь' => 3,
        'тверь' => 3,
        'иваново' => 3,
        'брянск' => 3,
        'сочи' => 3,
        'белгород' => 3,
        'владимир' => 3,
        'архангельск' => 3,
        'калуга' => 3,
        'симферопль' => 3,
        'смоленск' => 3,
        'орёл' => 3,
        'череповец' => 3,
        'вологда' => 3,
        'владикавказ' => 3,
        'саранск' => 3,
        'мурманск' => 3,
        'тамбов' => 3,
        'грозный' => 3,
        'кострома' => 3,
        'петрозаводск' => 3,
        'йошкар-ола' => 3,
        'новороссийск' => 3,
        'таганрог' => 3,
        'сыктывкар' => 3,
        'нальчик' => 3,
        'шахты' => 3,
        'нижнекамск' => 3,
        'дзержинск' => 3,
        'старый оскол' => 3,
        'великий новгород' => 3,
        'псков' => 3,
        'минеральные воды' => 3,
        'казань' => 4,
        'самара' => 4,
        'тольятти' => 4,
        'ижевск' => 4,
        'тольятти' => 4,
        'екатеринбург' => 5,
        'челябинск' => 5,
        'уфа' => 5,
        'пермь' => 5,
        'тюмень' => 5,
        'оренбург' => 5,
        'магнитогорск' => 5,
        'нижний тагил' => 5,
        'сургут' => 5,
        'курган' => 5,
        'стерлитамак' => 5,
        'нижневартовск' => 5,
        'орск' => 5,
        'новосибирск' => 6,
        'омск' => 6,
        'новосибирск' => 6,
        'барнаул' => 6,
        'томск' => 6,
        'бийск' => 6,
        'красноярск' => 7,
        'новокузнецк' => 7,
        'кемерово' => 7,
        'прокопьевск' => 7,
        'иркутск' => 8,
        'улан-удэ' => 8,
        'братск' => 8,
        'ангарск' => 8,
        'чита' => 9,
        'якутск' => 9,
        'благовещенск' => 9,
        'хабаровск' => 10,
        'владивосток' => 10,
        'комсомольск-на-амуре' => 10
    );

    public $sub_sms_send_params = Array(
        "action" => "issue.send",
        "letter" => array("from.name" => "lensmaster", "draft.id" => "252"),
        "group" => "personal",
        "mute" => "1",
        "sendwhen" => "later");

    function action($params)
    {
        $this->toSSLog('sendsayActionRecord :' . print_r(var_export($params, true), true));
        return $this->subscribeAction($params);
    }

    public function subscribeAction($data)
    {
        $answer     = array();

        // пробуем оптравить
        $this->sub_subscribe_params['email']               = $data['email'];
        //$this->sub_subscribe_params['cellphone']           = $data['phone'];
        $this->sub_subscribe_params['obj']['a25']['q63'] = $data['record_id'];


//        $longUrl = "https://www.lensmaster.ru/saloni-optiki/zapis/?STEP=success&RECORD_ID=".$data['record_id'];
        $longUrl = "https://www.lensmaster.ru/saloni-optiki/zapis/".$data['record_UID']."/?STEP=success";
        $this->sub_subscribe_params['obj']['a25']['q572'] = $longUrl;
        // Get API key from : http://code.google.com/apis/console/
        $apiKey = 'AIzaSyAJtERicsaNLYiD6IhDtJTyIxCtvVC89DQ'; //  AIzaSyC9kqy-YGDWPgzRQGh4f4PIrfmUd9_S1Rc
        $postData = array('longUrl' => $longUrl, 'key' => $apiKey);
        $jsonData = json_encode($postData);
        $curlObj = curl_init();
        curl_setopt($curlObj, CURLOPT_URL, 'https://www.googleapis.com/urlshortener/v1/url?key='.$apiKey);
        curl_setopt($curlObj, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($curlObj, CURLOPT_SSL_VERIFYPEER, 0);
        curl_setopt($curlObj, CURLOPT_HEADER, 0);
        curl_setopt($curlObj, CURLOPT_HTTPHEADER, array('Content-type:application/json'));
        curl_setopt($curlObj, CURLOPT_POST, 1);
        curl_setopt($curlObj, CURLOPT_POSTFIELDS, $jsonData);
        $response = curl_exec($curlObj);
        $json = json_decode($response);
        curl_close($curlObj);
        $this->sub_subscribe_params['obj']['a25']['q884'] = $json->id;

        $this->sub_subscribe_params['obj']['a25']['q911'] = date("Y-m-d H:i");
        $temp0 = explode(' ', $data['record_date']);
        $temp = explode('.', $temp0[0]);
        if (in_array($temp0[0], $this->promos)) {
            $this->sub_subscribe_params['obj']['a25']['q628'] = array_search($temp0[0], $this->promos);
        } else {
            $this->sub_subscribe_params['obj']['a25']['q628'] = "";
        }
        $absolut_date = implode('-', array_reverse($temp))." ".$temp0[1];
        $this->sub_subscribe_params['obj']['a25']['q942'] = $absolut_date;
        if (!empty($data['city']) && isset($this->cities[ strtolower( $data['city'] ) ])) {
            $absolut_date = date('Y-m-d H:i',strtotime(($this->cities[ 'москва' ] - $this->cities[ strtolower( $data['city'] ) ]).' hour',strtotime($absolut_date.':00')));
        }
        $this->sub_subscribe_params['obj']['a25']['q427'] = $absolut_date;
        $this->sub_subscribe_params['obj']['a25']['q928'] = round((strtotime($this->sub_subscribe_params['obj']['a25']['q427']) - strtotime($this->sub_subscribe_params['obj']['a25']['q911']))/3600);
        $this->sub_subscribe_params['obj']['a25']['q801'] = $data['salon'];
        $this->sub_subscribe_params['obj']['a25']['q54'] = $data['url_regedit'];
        $this->sub_subscribe_params['obj']['a25']['q630'] = $data['city'];
        $this->sub_subscribe_params['obj']['a25']['q16'] = $data['salon_adres'];
        $this->sub_subscribe_params['obj']['a25']['q506'] = $data['salon_phone'];
        $this->sub_subscribe_params['obj']['a25']['q743'] = $data['doctor'];
        $this->sub_subscribe_params['obj']['a25']['q731'] = $data['doctor_pic'];
        $this->sub_subscribe_params['obj']['a25']['q440'] = array($data['mail']);
        $this->sub_subscribe_params['head_attach'] = array(array(
            "head" => $data['phone'],
            "head_add_type" => "msisdn",
            "newbie.confirm" => 0,
            "head_rule" => array (
                "multi" => "transplant",
                "single"=> "transplant",
                "newbie"=> "attach"
            )
        ));


        $exit_code=true;
        $counter = 0; // чтобы избежать зацикливания
        while ($exit_code===true && $counter < 10) {
            $exit_code = $this->sub_login();
            $counter++;
        }
        // удаляем уже пирвязанные телефоны от емаила
        $ids = Array(
            "action" => "member.head.list",
            "addr_type" => "email",
            "email" => $data['email']);
        $res = $this->sub_api_execute($ids);
        $ans=json_decode($res, true);
        if (!empty($ans['list'])) {
            foreach ($ans['list'] as $key => $value) {
                if ($value['email'] != $data['email']) {
                    $this->sub_detach_params['email']            = $value['email'];
                    $res = $this->sub_api_execute($this->sub_detach_params);
                }
            }
        }

        $res = $this->sub_api_execute($this->sub_subscribe_params);
        $ans=json_decode($res, true);

        if($this->logger){
            $this->logger->info('Request params ' . urldecode($_SERVER['QUERY_STRING']));
            $this->logger->info('Sendsay params ' . print_r($this->sub_subscribe_params, true) );
            $this->logger->info('Sendsay response ' . print_r($ans, true) );
        }
/*
        if (extension_loaded('ssh2')) {
            $local_file = 'check_eyes.log';
            $server_file = '/var/www/clients/client1/web3/home/Futurebit1/export_logs/check_eyes.log';
            $connection = ssh2_connect('82.202.225.103', 55567);
            ssh2_auth_password($connection, 'Futurebit1', 'dnui!ZppFGXC8');

            ssh2_scp_recv($connection, $server_file, $local_file);

            $date_to_clear = '***** '.date('Y-m-d', strtotime('-5 days'));
            $log_content = '
***** '.date("Y-m-d H:i:s", strtotime('-0 days')).' request params '.urldecode($_SERVER['QUERY_STRING']).'
';
            $log_content .= date("Y-m-d H:i:s").' sendsay params '.print_r($this->sub_subscribe_params, true).'
';
            $log_content .= date("Y-m-d H:i:s").' sendsay response '.print_r($ans, true).'
		
';
            $file_data = $log_content;
            $file_data .= file_get_contents($local_file);
            if( ($x_pos = strpos($file_data, $date_to_clear)) !== FALSE ) {
                $file_data = substr($file_data, 0, $x_pos);
            }

            file_put_contents($local_file, $file_data);
            ssh2_scp_send($connection, $local_file, $server_file, 0777);
            if (file_exists($local_file)) unlink($local_file);
        } else {
            echo "not loaded ssh2 extension, so we can record log file<br/>";
        }
*/
        $this->sub_send_params['users.list']         = $data['email'];
        $res = $this->sub_api_execute($this->sub_send_params);
        $ans=json_decode($res, true);

/*
        // отправляем смс за 2 часа до проверки зрения q942
        $this->sub_sms_send_params['email']         = $data['phone'];
        $t = strtotime($absolut_date.":00");
        $t = $t - 7200;
        $d = date('Y-m-d H:i', $t );
        $this->sub_sms_send_params['later.time']         = $d; // "YYYY-MM-DD hh:mm" 2017-12-22 22:54
        $res = $this->sub_api_execute($this->sub_sms_send_params);
        $ans=json_decode($res, true);
*/

        $this->sub_sms_send_params['email']     = $data['phone'];
        $this->sub_sms_send_params['letter']    = array("draft.id" => "515");
        $this->sub_sms_send_params['sendwhen']  = "now";
        $res = $this->sub_api_execute($this->sub_sms_send_params);
        $ans=json_decode($res, true);
        //echo "<pre>";
        //print_r($ans);
        //echo "</pre>";
        $this->sub_logout();
        $ans=json_decode($res, true);
        return $ans;

    }
}
